version: 2.1
jobs:
  setup-python-venv:
    docker:
      - image: cimg/python:3.9.2
    steps:
      - checkout
      - restore_cache:
          keys: 
            - python-venv-a-{{ checksum "requirements.txt" }}
            - python-venv-a-
      - run:
          name: setup python venv and install requirements
          command: |
            python -m venv .venv
            . .venv/bin/activate
            pip install -r requirements.txt
      - save_cache:
          paths: [.venv]
          key: python-venv-a-{{ checksum "requirements.txt" }}
  
  setup-hadolint:
    docker:
      - image: cimg/python:3.9.2
    environment:
      HADOLINT_DL_ADDR: "https://github.com/hadolint/hadolint/releases/download/v1.23.0/hadolint-Linux-x86_64"
    steps:
      - restore_cache:
          keys: 
            - hadolint-$HADOLINT_DL_ADDR
      - run:
          name: install hadolint binary
          command: |
            if [ ! -f ./hadolint/hadolint ] ; then
              mkdir -p hadolint/ || true
              wget -O ./hadolint/hadolint $HADOLINT_DL_ADDR
              chmod +x ./hadolint/hadolint
            fi
      - save_cache:
          paths: [hadolint]
          key: hadolint-$HADOLINT_DL_ADDR

  lint-app:
    docker:
        - image: cimg/python:3.9.2
    steps:
      - checkout
      - restore_cache:
          keys: 
            - python-venv-a-{{ checksum "requirements.txt" }}
            - python-venv-a-
      - run:
          name: linting application and smoke test
          command: |
            . .venv/bin/activate
            pylint *.py
  app-smoke-test:
    docker:
        - image: cimg/python:3.9.2
    steps:
      - checkout
      - restore_cache:
          keys: 
            - python-venv-a-{{ checksum "requirements.txt" }}
            - python-venv-a-
      - run:
          name: run bare application smoke test
          command: |
            . .venv/bin/activate
            python app.py &
            # note that sleep could cause flakiness - but ... damn.
            sleep 1
            nosetests -v smoke_test.py
  lint-dockerfile:
    docker:
        - image: cimg/python:3.9.2
    steps:
      - checkout
      - restore_cache:
          keys: 
            - hadolint-$HADOLINT_DL_ADDR
            - hadolint-
      - run:
          name: linting application dockerfile
          command: |
            ./hadolint/hadolint Dockerfile
  build-app-container:
    docker:
        - image: cimg/python:3.9.2
    steps:
      - checkout
      - restore_cache:
          keys: 
            - python-venv-a-{{ checksum "requirements.txt" }}
            - python-venv-a-
      - setup_remote_docker:
          version: 19.03.13
      - run: 
          name: build application container
          command: |
            TAG=0.1.$CIRCLE_BUILD_NUM
            docker build -t cowsay-web:$TAG .
            echo "${DOCKER_PASSWORD}" | docker login --username ${DOCKER_ID} --password-stdin
            docker tag cowsay-web:$TAG ${DOCKER_ID}/cowsay-web:$TAG
            docker tag cowsay-web:$TAG ${DOCKER_ID}/cowsay-web:latest
            docker push ${DOCKER_ID}/cowsay-web
  container-smoke-test:
    docker:
        - image: cimg/python:3.9.2
    steps:
      - checkout
      - restore_cache:
          keys: 
            - python-venv-a-{{ checksum "requirements.txt" }}
            - python-venv-a-
      - setup_remote_docker:
          version: 19.03.13
      - run:
          name: run smoke test against app container
          command: |
            docker run --rm -d -p 8080:8080 ${DOCKER_ID}/cowsay-web:latest
            docker ps
            # note again that sleep could cause flakiness - but ... damn, again.
            sleep 1
            . .venv/bin/activate
            nosetests -v smoke_test.py
workflows:
  default:
    jobs:
      - setup-python-venv
      - setup-hadolint
      - lint-app:
          requires: [setup-python-venv]
      - app-smoke-test:
          requires: [lint-app]
      - lint-dockerfile:
          requires: [setup-hadolint]
      - build-app-container:
          requires: [app-smoke-test, lint-dockerfile]
      - container-smoke-test:
          requires: [build-app-container]
            

          